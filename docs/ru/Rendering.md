# Процесс рендеринга страницы в мире Монстра

## Основные понятия

- **Material** - основная единица рендеринга. По сути это декларация отображения контентного блока.
- **DataEntityProvider** - провайдер входящей информации, необходимой для рендеринга материала.

### Template

Шаблон страницы, разбитый на регионы(**TemplateRegion**).

Регион - семантическая область шаблона, определяющая перечень материалов для отображения.

Основные характеристики TemplateRegion:
- Регионы рендерятся по порядку(`sort_order`)
- Регион может быть зависим от сущности(`entity_dependent`). В таком случае, он НЕ содержит в себе материалы — они добавляются из контента сущности.
- Для регионов **пока что** не реализовано отдельное кеширование.
- У шаблона может быть несколько регионов, зависимых от сущности.

Поскольку для рендеринга материалов необходимы данные - каждый Template имеет свои провайдеры(`packed_json_providers`).
Предназначение провайдеров в шаблоне - передача данных в регионы, независящие от сущности.

### Layout

Layout - особенный вид `Template`, который необходим для задания общего макета страницы(шапка, сайдбар, подвал и т.п.).
Признак того, что Template является Layout-ом - поле `is_layout`.

Особенные характеристики:
- Не может быть регионов, зависимых от сущностей
- Для отображения контента сущности необходимо использовать материал `core.frontend-monster-core.general.content-placeholder`, который внутри себя представляет простой вызов `<?=$content?>`, как в обычных шаблонах yii2.

**:exclamation: ВАЖНО** При реализации кеширования в **TemplateRegion** необходимо запрещать кеширование регионов, содержащих `content-placeholder`.

### Контент сущности

Каждая сущность, которая претендует на звание `MainEntity` должна:
- Использовать примесь `DotPlant\Monster\Universal\MonsterEntityTrait`, либо реализовывать аналогичные методы.
- Иметь собственное хранилище материалов и провайдеров для контента(обычно это поля `packed_json_content` и `packed_json_providers`).

### Процесс рендеринга

1. Определяем главную сущность
2. Определяемся  с шаблоном, в которой будет рисоваться сущность в следующем порядке:
    - Проверяем `MainEntity::forceTemplate` (по ключу)
    - Берём шаблон из сущности `$entity->getTemplateId()` (по id)
    - Берём шаблон по умолчанию `MainEtntity::defaultTemplateKey` (по ключу)
3. Регионы берём из шаблона.
4. Сливаем(`ArrayHelper::merge`) провайдеры шаблона и сущности.
5. Если пришёл разрешенный POST запрос на действие save или preview(добавление/применение материалов и провайдеров):
    - Добавляем провайдеры в сущность, поскольку интерфейс редактирования шаблона будет отдельно
    - Добавляем материалы в регионы
    - Создаем StaticContentProvider или используем существующий для новых материалов с данными на основе их sampleData
    - Сохраняем материалы и провайдеры в сущность, если действие save
6. Применяем layout на основе поля сущности или layout по-умолчанию.
    - В качестве `$content` будет монстроконтент от всех регионов текущего шаблона
    - Layout рендерится основе представления `@DotPlant/Monster/views/layout-template.php`
    - Контент всех регионов шаблона рендерится на основе представления `@DotPlant/Monster/views/monster-template.php`