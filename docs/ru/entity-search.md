# EntitySearch

Компонент для поиска сущностей по полям модели и ее свойствам.

## Поиск по полям

Это самый простой вариант поиска, он работает через `ActiveQuery` и использует вашу текущую базу данных.

## Поиск по свойствам

Вот это действительно полезная вещь. Для этого используется компонент поиска из расширения `devgroup/yii2-data-structure-tools`.

На данный момент возможен поиск через стандартные средства (`DevGroup\DataStructure\search\common\Search`) или через elasticsearch (`DevGroup\DataStructure\search\elastic\Search`).

Подробнее о настройке читайте на странице [расширения](https://github.com/DevGroup-ru/yii2-data-structure-tools).

## Доступные методы

В первую очередь необходимо создать экземпляр класса. Конструктор принимает два параметра. Первый - это название модели ActiveRecord, второй - количетсво элементов результата (по умолчанию 10).

Далее можно приступить к указанию значений для фильтрации. Список методов следующий:

* `whereAttributes($params = [])` - Добавляет к запросу условия фильтрации по полям модели. Принимает массив в виде `'имя_поля' => 'значение_поля'`
* `whereAttributesContain($attributes, $value, $intersect = false)` - поиск совпадений в значении атрибута модели. Принимаем параметры:
    * массив названий полей
    * искомый текст
    * режим поиска `false` - надо найти совпадение хотя бы в одном из полей, `true` - надо найти в каждом поле
* `whereProperties($params = [])` - Добавляет к запросу условия фильтрации по свойствам. Принимает массив в виде `'id_свойства' => ['значение_1', 'значение_3']`

Они устроены, как `Method chaining`. Каждый из них возвращает эклемпляр класса от которого он вызывался.

Когда запрос построен, можно получить следующую информацию:

* `count()` - получить количество моделей, отвечающих запросу
* `all($page = 1)` - получить массив моделей. Данный метод принимает один параметр - страница результата

## Использование

Ниже вы можете увидеть несколько примеров искользования.

Пример №1. Поиск по ключевой фразе

```php
$es = new EntitySearch(Page::class, 5); // Ищем по модели Page. Количество результатов на странице - 5
$es->whereAttributesContain(['name', 'content'], 'news', true); // Выражение "news" должно одновременно встречаться в полях name и content
$result = $es->all(); // вернуть первую страницу с результатами
```

Пример №2. Тот же поиск, но с дополнительным условием 

```php
$es = new EntitySearch(Page::class, 5); // Ищем по модели Page. Количество результатов на странице - 5
$es->whereAttributesContain(['name', 'content'], 'news', true); // Выражение "news" должно одновременно встречаться в полях name и content
$es->whereAttributes(['published' => 1]); // Дополнительное условие, что страница должна быть опубликована
$result = $es->all(); // вернуть первую страницу с результатами
```

Пример №3. Поиск по свойствам

```php
$es = new EntitySearch(Page::class); // Ищем по модели Page. Количество результатов на странице - 10
$es->whereProperties([88 => [113, 127]]); // свойство с идентификатором 88 должно быть равно 113 или 127
$result = $es->all(2); // вернуть вторую страницу с результатами
```

Пример №4. Тот же вызов, но в одну строку

```php
$result = (new EntitySearch(Page::class))->whereProperties([88 => [113, 127]])->all(2);
```
